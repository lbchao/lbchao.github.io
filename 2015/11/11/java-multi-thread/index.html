<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>java_multi_thread | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="主要讲解线程周期及多线程，线程池的知识">
<meta property="og:type" content="article">
<meta property="og:title" content="java_multi_thread">
<meta property="og:url" content="http://yoursite.com/2015/11/11/java-multi-thread/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="主要讲解线程周期及多线程，线程池的知识">
<meta property="og:updated_time" content="2015-11-11T14:33:30.466Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java_multi_thread">
<meta name="twitter:description" content="主要讲解线程周期及多线程，线程池的知识">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-java-multi-thread" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/11/java-multi-thread/" class="article-date">
  <time datetime="2015-11-11T14:30:45.000Z" itemprop="datePublished">2015-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      java_multi_thread
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>主要讲解线程周期及多线程，线程池的知识<br><a id="more"></a><br>几乎所有的操作系统都支持同时运行多个任务，一个任务通常就是一个程序，每个运行中的程序就是一个进程。当一个程序运行时，内部可能包含了多个顺序执行流，每个顺序执行流就是一个线程。<br>几乎所有的操作系统都支持进程的概念，所有运行中的任务通常对应一个进程。当一个程序进入内存运行时，即变成一个进程。进程是处于运行过程中的程序，并且具有一定的独立功能，进程是系统进行资源分配和调度的一个独立单位。<br>进程包含三个特征：<br>独立性：进程是系统中独立存在的实体，它可以拥有自己独立的资源，每个进程都拥有自己私有的地址空间。在没有经过进程本身允许的情况下，一个用户进程不可以直接访问其他进程的地址空间。<br>动态性：进程与程序的区别在于，程序是一个静态的指令集合，而进程是一个正在系统中活动的指令集合。在进程中加入了时间的概念。进程具有自己的生命周期和各种不同的状态，这些概念在程序中都是不具有的。<br>并发性：多个进程可以在单个处理器上并发执行，多个进程之间不会相互影响。</p>
<p>（并发性和并行性是两个概念，并行指同一时刻，有多条指令在多个处理器上同时执行，并发性指在同一时刻只能有一条指令执行，但多个进程指令被快速轮换执行，使得在宏观上具有多个进程同时执行的效果）</p>
<p>多线程则扩展了多进程的概念，使得同一个进程可以同时并发处理多个任务。线程可以称作轻量级进程，线程是进程的执行单元。<br>线程是进程的组成部分，一个进程可以拥有多个线程，一个线程必须有一个父进程。线程可以拥有自己的堆栈，自己的程序计算器和自己的局部变量，但不可以拥有系统资源，它与父进程的其他线程共享改进程所拥有的全部资源。<br>简而言之，一个程序运行后至少有一个进程，一个进程里可以包含多个线程，但是至少包含一个线程。</p>
<p>多线程优势<br>当操作系统创建一个进程时，必须为改进程分配独立的内存空间，并分配大量的相关资源；但创建一个线程简单的多，实用多线程来实现并发比实用多进程实现并发的性能要高的多。<br>多线程编程优点：<br>1进程直接不能共享内存，但线程之间共享内存非常容易<br>2系统创建进程时需要为进程重新分配系统资源，创建线程代价小得多，使用多线程来实现多任务并发比多进程的效率高。<br>3java语言内置了多线程功能支持，而不是单纯的作为底层操作系统的调度方式，从而简化了java的多线程编程。</p>
<p>继承Thread 类创建线程类</p>
<p>1  定义thread子类，重写run()方法-代表执行体<br>2  创建Thread子类实例，即创建线程对象<br>3  调用线程对象start方法启动线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstThread</span>  <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span>  <span class="keyword">int</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			System.out.println(getName()+<span class="string">"  "</span>+i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">			<span class="keyword">if</span>(i==<span class="number">20</span>)&#123;</span><br><span class="line">				<span class="comment">//创建启动线程</span></span><br><span class="line">				<span class="keyword">new</span> FirstThread().start();</span><br><span class="line">				<span class="keyword">new</span> FirstThread().start();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  实现Runnable接口创建线程类</p>
<p>1定义Runnable接口实现类，重写run（）方法，该方法同样是改线程的线程执行体<br>2创建Runnable实现类的实例，并以此实例作为Thread的target来创建Thread对象，该Thread对象才是真正的线程对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">        	System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">        	<span class="keyword">if</span>(i==<span class="number">20</span>)&#123;</span><br><span class="line">        		SecondThread  st=<span class="keyword">new</span> SecondThread();</span><br><span class="line">        		<span class="keyword">new</span> Thread(st, <span class="string">"thread-one"</span>).start();</span><br><span class="line">        		<span class="keyword">new</span> Thread(st,<span class="string">"thread-two"</span>).start();</span><br><span class="line">        		</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Callable和Future创建线程</p>
<p>1创建Callable接口的实现类，并实现call()方法，该call（）方法作为线程执行体，且该call()方法有返回值，再创建Callable实现类的实例。<br>2使用FutureTask类包装Callable对象，该FutureTask对象封装了该Callable对象的call（）方法的返回值<br>3使用FutureTask对象作为Thread对象的target创建并启动线程<br>4调用FutureTask对象的get()方法来获得子线程执行结束后的返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThirdThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ThirdThread  rt=<span class="keyword">new</span> ThirdThread();</span><br><span class="line">		FutureTask&lt;Integer&gt; task=<span class="keyword">new</span> FutureTask&lt;&gt;(<span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="annotation">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				<span class="keyword">int</span>  i=<span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span>(;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">					System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+<span class="string">" "</span>+i);</span><br><span class="line">			<span class="keyword">if</span>(i==<span class="number">20</span>)&#123;</span><br><span class="line">			  <span class="keyword">new</span> Thread(task, <span class="string">"return thread"</span>).start();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">int</span>  value=task.get();</span><br><span class="line">			System.out.println(<span class="string">"return value"</span>+value);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">			<span class="comment">// <span class="doctag"><span class="keyword">TODO</span></span> Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建线程的三种方式对比</p>
<p>通过继承Thread类及实现Runnable,Callable接口都可以实现多线程，实现Runnable接口与实现Callable接口的方式基本相同，只是Callable接口定义的方法有返回值，可以声明抛出异常。因此可以将实现Runnalbe接口和实现Callable接口归为一种方式，这种方式与继承Thread方式之间的主要差别如下。</p>
<p>采用实现Runnalbe，Callable接口的方式创建多线程的优缺点：</p>
<p>1线程类只是实现了Runnable接口或者Callable接口，还可以继承其他类</p>
<p>2这种方式下，多个线程可以共享一个target对象，所以非常适合多个相同线程来处理同一份资源，从而可以将CPU，代码和数据分开，形成清晰的模型，较好的体现了面向对象的思想。</p>
<p>3编程稍微复杂，如果需要访问当前线程，必须使用Thread.currentThread()方法。</p>
<p>采用继承Thread类的方式创建多线程的优缺点：</p>
<p>1缺点，因为线程已经继承了Thread类，所以不能继承其他父类。</p>
<p>2优点，编写简单，如果需要访问当前线程，则无需使用Thread.currentThread（）,直接使用this即可。</p>
<p>总结，一般使用实现Runnable接口，Callable接口的方式创建多线程。</p>
<p>线程的生命周期</p>
<p>当线程被创建并启动后，它不是一启动就进入了执行状态，也不少一直处于执行状态，在线程的生命周期当中，它需要经过：<br>创建      就绪       运行    阻塞        死亡<br>5种状态。尤其是当线程启动以后，它不可能一直霸占着cpu，所以cpu需要在多条线程之间切换，于是线程状态也是多次在运行，阻塞之间切换。</p>
<p>新建和就绪状态</p>
<p>当程序 使用了new关键字创建了一个线程之后，该线程就处于新建状态，此时它和其他的java对象一样，仅仅由java虚拟机为其分配内存，并初始化成员变量值，此时的线程对象没有表现出任何线程的动态特征，程序也不会执行线程的线程执行体。</p>
<p>当线程对象调用了start（）方法之后，该线程处于就绪状态，java虚拟机会为其创建方法调用栈和程序计数器，处于这个状态的线程并没有开始运行，只是表示该线程可以运行了，至于该线程何时开始运行，取决于JVM里线程调度器的调度。</p>
<p>注意（启动线程使用start方法，不是run方法，永远不要调用线程对象的run方法。<br>调用start方法来启动线程，系统会把该run方法当初线程执行体来处理；<br>但如果直接调用线程对象run方法，则run方法立即就会执行，而且在run方法返回之前其他线程无法并发执行，也就是说，如果直接调用线程对象run方法，系统把线程对象当做一个普通的对象，run方法也是一个普通的方法，而不是线程执行体）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokeRun</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//重写run方法，run（）方法的方法体就是线程执行体</span></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	      <span class="keyword">for</span>(;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">	    	  System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">	    	  </span><br><span class="line">	    	  </span><br><span class="line">	      &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		     </span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">			<span class="keyword">if</span>(i==<span class="number">20</span>)&#123;</span><br><span class="line">				<span class="comment">//直接调用线程的run方法，系统把线程对象当普通对象，依次执行方法</span></span><br><span class="line">				<span class="keyword">new</span> InvokeRun().run();</span><br><span class="line">				<span class="keyword">new</span> InvokeRun().run();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行和阻塞状态</p>
<p>如果处于就绪状态的线程获得了cpu开始执行run方法的线程执行体，则该线程处于运行状态。<br>如果计算机只有一个cpu，那么在任何时刻只有一个线程处于运行状态，当然，在一个多处理器的机器上，将有多个线程并行执行，当线程数大于处理器数时，依然会存在多个线程在同一个cpu上轮换的现象。<br>当一个线程开始运行后，它不可能一直处于运行状态，线程在运行过程中需要被中断，目的是使其他线程获得执行机会，线程调度的细节取决于底层平台采用的策略。<br>发生以下情况时，线程进入阻塞状态：</p>
<p>1线程调用sleep方法主动放弃所占用的处理器资源<br>2线程调用了一个阻塞时IO方法，在该方法返回之前，该线程被阻塞<br>3线程试图获得一个同步监视器，但该同步监视器正被其他线程所持有。<br>4线程在等待某个通知<br>5程序调用了线程的suspend方法将线程挂起，这个方法容易导致死锁，所以应该尽量避免使用该方法。</p>
<p>当前正在执行的线程被阻塞后，其他线程可以获得执行机会，被阻塞的线程会在合适的时候重新进入就绪状态，就绪状态而不是运行状态。也就说，被阻塞线程的阻塞解除后，必须重新等待线程调度器再次调用它。<br>针对上面几种情况，当发生如下特定的情况时可以解除上面的阻塞，让该线程重新进入就绪状态。</p>
<p>1调用sleep方法的线程经过了指定时间<br>2线程调用的阻塞Io方法已返回<br>3线程成功的获得了试图取得的同步监视器<br>4线程正在等待某个通知时，其他线程发出了一个通知<br>5处于挂起状态的线程被调用了resume恢复方法</p>
<pre><code>（阻塞-&gt;就绪）         阻塞                  （阻塞&lt;-运行）
sleep时间到                                   <span class="function"><span class="title">sleep</span><span class="params">()</span></span>
Io方法返回                                     Io阻塞
获得同步锁                                   等待同步锁
收到通知                                     等待通知
resume                                       suspend
</code></pre><p> 新建     （start-&gt;）     就绪   (得到处理器资源 -&gt;)         运行      （stop-&gt;）                     死亡<br>                                 (&lt;- yield ，失去处理器资源)            (Error，Expection-&gt;)<br>                                                                        (run(),call()执行完成-&gt;)</p>
<pre><code>线程基本状态图       
</code></pre><p>线程死亡</p>
<p>线程会以如下三种方式结束，结束后就处于死亡状态。</p>
<p>1。run()方法或call()方法执行完成，线程正常结束<br>2。线程抛出一个未捕获的Exception或者Error<br>3。直接调用该线程的stop方法来结束该线程-该方法容易导致死锁，通常不推荐使用。</p>
<p>控制线程</p>
<p>join线程</p>
<p>Thread 提供了让一个线程等待另一个线程完成的方法-join方法。当在某个程序执行流中调用其他线程的join方法时，调用线程将被阻塞，直到被join方法加入的join线程执行完为止。</p>
<p>join方法通常由使用线程的程序调用，以将大问题划分成许多小问题，每个小问题分配一个线程，当所有的小问题都得到处理后，在调用主线程进一步操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span>  <span class="title">JoinThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(name);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			System.out.println(getName()+<span class="string">"  "</span>+i);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> JoinThread(<span class="string">"new thread"</span>).start();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(i==<span class="number">20</span>)&#123;</span><br><span class="line">			   JoinThread  jt=<span class="keyword">new</span> JoinThread(<span class="string">"join thread"</span>);</span><br><span class="line">			   jt.start();</span><br><span class="line">			   <span class="keyword">try</span> &#123;</span><br><span class="line">				jt.join();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag"><span class="keyword">TODO</span></span> Auto-generated catch block</span></span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后台线程</p>
<p>有一种线程，它是后台运行的，它的任务是为其他的线程提供服务，这种线程被称为后台线程，又称为守护线程或精灵线程。JVM的垃圾回收线程就是典型的后台线程。<br>后台线程有个特征：如果所有的前台线程都死亡，后台线程将会死亡。</p>
<p>线程睡眠：sleep</p>
<p>如果需要让当前正在执行的线程暂停一段时间，并进入阻塞状态，则可以通过调研Thread类的今天sleep方法来实现，sleep方法有两种重载形式。</p>
<p>1static void sleep （long millis）<br>让当前正在执行的线程暂停millis毫秒，并进入阻塞状态，该方法受系统计时器和线程调度器的精度和准确度的影响。<br>2static void  sleep（long millis,int nanos）<br>让当前正在执行的线程暂停millis毫秒，加nanos毫微妙，并进入阻塞状态，该方法很少调用第二种形式的sleep（）方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">			</span><br><span class="line">			System.out.println(<span class="string">"time:"</span>+<span class="keyword">new</span> Date());</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag"><span class="keyword">TODO</span></span> Auto-generated catch block</span></span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>time:Tue Nov 10 16:45:20 CST 2015<br>time:Tue Nov 10 16:45:21 CST 2015<br>time:Tue Nov 10 16:45:22 CST 2015<br>time:Tue Nov 10 16:45:23 CST 2015<br>time:Tue Nov 10 16:45:24 CST 2015<br>time:Tue Nov 10 16:45:25 CST 2015<br>time:Tue Nov 10 16:45:26 CST 2015<br>time:Tue Nov 10 16:45:27 CST 2015<br>time:Tue Nov 10 16:45:28 CST 2015<br>time:Tue Nov 10 16:45:29 CST 2015<br>输出时间间隔在1毫秒，因为该线程只有一个主线程，当主线程进入睡眠后，系统没有可执行的线程，所以看到程序在sleep暂停。</p>
<p>线程让步：yield</p>
<p>yield方法也是一个和sleep方法有点相似的方法，它也是Thread类提供的一个静态方法，它可以让当前正在执行的线程暂停，但它不会阻塞线程，它只是将该线程转入就绪状态。yield只是让当前线程暂停一下，让系统的线程调度器重新调度一次，完全可能的情况是：<br>当某个线程调用了yield方法暂停之后，线程调度器又将其调度出来重新执行。<br>实际上，当某个线程调用了yield方法暂停之后，只有优先级与当前线程相同，或者优先级比当前线程更高的处于就绪状态的线程才会获得执行机会。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YieldTest</span>  <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span>  <span class="title">YieldTest</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	  </span><br><span class="line">	  </span><br><span class="line">	     <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>;i++)&#123;</span><br><span class="line">	    	  System.out.println(getName()+<span class="string">"  "</span>+i);</span><br><span class="line">	    	  </span><br><span class="line">	    	  <span class="keyword">if</span>(i==<span class="number">20</span>)&#123;</span><br><span class="line">	    		  Thread.yield();</span><br><span class="line">	    	  &#125;</span><br><span class="line">	    	  </span><br><span class="line">	     &#125;</span><br><span class="line">	    </span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">		YieldTest  ytOne=<span class="keyword">new</span> YieldTest(<span class="string">"high thread"</span>);</span><br><span class="line">		ytOne.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">		ytOne.start();</span><br><span class="line">		YieldTest  yeTwo=<span class="keyword">new</span> YieldTest(<span class="string">"low thread"</span>);</span><br><span class="line">		yeTwo.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">		yeTwo.start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于sleep方法和yield方法的区别如下。<br>1sleep方法暂停当前线程后，会给其他线程执行机会，不会理会其他线程的优先级；但是yield方法只会给优先级相同，或优先级更高的线程执行机会。</p>
<p>2sleep方法会将线程转入阻塞状态，直到经过阻塞时间才会转入就绪状态，而yield不会将线程转入阻塞状态，它只是强制当前线程进入就绪状态。因此完全有可能某个线程yield方法后暂停之后，立即再次获得处理器资源被执行</p>
<p>3sleep方法声明抛出了InterputedException异常，所以调用sleep方法要么捕获改异常，要么显示抛出异常；而yield方法则没有声明抛出任何异常</p>
<p>4sleep放比yield方法有更好的可移植性，通常不建议使用yield方法来控制并发线程的执行。</p>
<p>改变线程优先级</p>
<p>每个线程执行时都具有一定的优先级，优先级高的线程获得较多的执行机会，而优先级第的线程则获得较少的执行机会。</p>
<p>每个线程默认的优先级都与创建它的父线程的优先级相同，在默认情况下，main线程具有普通优先级，由main线程创建的子线程也具有普通优先级。<br>Thread 类 提供了setPriority(),getPriority()方法来设置和返回线程的优先级，其中，setPriority()方法的参数可以是一个整数，1~10之间，也可以使用Thread类的如下三个静态常量。</p>
<p>MAX_PRIORITY  10<br>MIN_PRIORITY  1<br>NORM_PRIORITY  5</p>
<p>同步代码块<br>//语法<br>synchroinzed(obj){</p>
<p>}</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String accountNo;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAccountNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountNo</span><span class="params">(String accountNo)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(<span class="keyword">double</span> balance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.balance = balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> balance;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span><span class="params">(String accountNo, <span class="keyword">double</span> balance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">		<span class="keyword">this</span>.balance = balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountNo.hashCode();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span> == obj)</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp; obj.getClass() == BankAccount.class) &#123;</span><br><span class="line">			BankAccount target = (BankAccount) obj;</span><br><span class="line">			<span class="keyword">return</span> target.getAccountNo().equals(accountNo);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//--------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟用户账户</span></span><br><span class="line">	<span class="keyword">private</span> BankAccount account;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> drawAmout;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DrawThread</span><span class="params">(String name, BankAccount account, <span class="keyword">double</span> drawAmout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">		<span class="keyword">this</span>.drawAmout = drawAmout;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 使用account 作为同步监视器，先获得account账号锁定，其他线程无法获得锁，也就无法修改</span></span><br><span class="line">		<span class="comment">// 加锁 修改 释放锁</span></span><br><span class="line">		<span class="keyword">synchronized</span> (account) &#123;</span><br><span class="line">          </span><br><span class="line">			<span class="keyword">if</span>(account.getBalance()&gt;drawAmout)&#123;</span><br><span class="line">				<span class="comment">//吐出钞票</span></span><br><span class="line">				System.out.println(getName()+<span class="string">"取钱成功 ，吐出钞票："</span>+drawAmout);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">1</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//修改金额</span></span><br><span class="line">				account.setBalance(account.getBalance()-drawAmout);</span><br><span class="line">				System.out.println(<span class="string">"余额："</span>+account.getBalance());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				System.out.println(getName()+<span class="string">"取钱失败，余额不足"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//同步代码块结束，该线程释放同步锁</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		BankAccount  acct=<span class="keyword">new</span> BankAccount(<span class="string">"1234"</span>, <span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">new</span> DrawThread(<span class="string">"a"</span>, acct, <span class="number">800</span>).start();</span><br><span class="line">		<span class="keyword">new</span> DrawThread(<span class="string">"b"</span>, acct, <span class="number">600</span>).start();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面语法格式中的synchronized括号里的object就是同步监视器</p>
<p>同步方法<br>与同步代码块对应，java多线程安全支持还提供了同步方法，同步方法就是使用synchronized关键字来修改某个方法，该方法是同步方法，同步方法的同步监视器是this，就是调用该方法的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String accountNo;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAccountNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountNo</span><span class="params">(String accountNo)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(<span class="keyword">double</span> balance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.balance = balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> balance;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span><span class="params">(String accountNo, <span class="keyword">double</span> balance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">		<span class="keyword">this</span>.balance = balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountNo.hashCode();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span> == obj)</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp; obj.getClass() == BankAccount.class) &#123;</span><br><span class="line">			BankAccount target = (BankAccount) obj;</span><br><span class="line">			<span class="keyword">return</span> target.getAccountNo().equals(accountNo);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 提供一个线程安全的draw方法来完成取钱操作</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">double</span> drawAmoutn)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (balance &gt;= drawAmoutn) &#123;</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+<span class="string">"取钱成功 ，吐出钞票："</span>+drawAmoutn);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">1</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//修改金额</span></span><br><span class="line">			balance-=drawAmoutn;</span><br><span class="line">			System.out.println(<span class="string">"余额："</span>+balance);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+<span class="string">"取钱失败，余额不足"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawTwoThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟用户账户</span></span><br><span class="line">	<span class="keyword">private</span> BankAccount account;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> drawAmout;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DrawTwoThread</span><span class="params">(String name, BankAccount account, <span class="keyword">double</span> drawAmout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">		<span class="keyword">this</span>.drawAmout = drawAmout;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		account.draw(drawAmout);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawTwoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		BankAccount  acct=<span class="keyword">new</span> BankAccount(<span class="string">"1234"</span>, <span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">new</span> DrawTwoThread(<span class="string">"a"</span>, acct, <span class="number">800</span>).start();</span><br><span class="line">		<span class="keyword">new</span> DrawTwoThread(<span class="string">"b"</span>, acct, <span class="number">600</span>).start();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>释放同步监视器的锁定</p>
<p>任何线程进入同步代码块，同步方法之前，必须先获得对同步监视器的锁定，那么何时释放同步监视器的锁定？</p>
<p>1当前线程的同步方法，同步代码块执行结束，释放同步监视器<br>2当前线程在同步代码库，同步方法遇到了break，return  终止了代码块，该方法的执行，释放同步监视器<br>3当前线程在同步代码库，同步方法中出现了未处理的error或者Exception,导致了该代码块，方法异常结束时，释放同步监视器<br>4当前线程执行同步代码块或同步方法时，程序执行了同步监视器对象的wait（）方法，则当前线程暂停，并释放同步监视器</p>
<p>如下情况，线程不会释放同步监视器：</p>
<p>1线程执行同步代码块或同步方法时，程序调用Thread.sleep,yield()方法暂停当前线程的执行，当前线程不会释放同步监视器。</p>
<p>2线程执行同步代码块时，其他线程调用了该线程的suspend()将该线程挂起，该线程不会释放同步监视器，当然，程序应该尽量避免使用suspend和resume方法来控制线程。</p>
<p>同步锁</p>
<p>java提供了线程同步机制，通过显示定义同步锁对象来实现同步，同步锁由Lock对象充当。<br>Lock提供了比synchronized方法和代码块更广泛的锁对象操作，Lock允许实现更灵活的结构。<br>Lock是控制多个线程对共享资源进行访问的工具。通常，锁提供了对共享资源的独占访问，每次只能有一个线程对lock对象加锁，线程访问共享资源之前应先获得Lock对象。</p>
<p>某些锁可能允许对共享资源并发访问，如ReadWriteLock(读写锁)，Lock, ReadWriteLock。<br>java8新增了新型的StampedLock类，在大多数场景中它可以替代ReentranReadWriteLock,ReentrantReadWriteLock为读写提供了三种锁模式：Writing  ReadingOptimistic Reading.</p>
<p>在实现线程安全的控制中，比较常用的就是ReentrantLock（可重入锁）。使用该锁可以显示的加锁，释放锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 可重入锁</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String accountNo;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> balance;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAccountNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountNo</span><span class="params">(String accountNo)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// public void setBalance(double balance) &#123;</span></span><br><span class="line">	<span class="comment">// this.balance = balance;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(String accountNo, <span class="keyword">double</span> balance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">		<span class="keyword">this</span>.balance = balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 提供线程安全的draw方法来完成取钱操作</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">double</span> drawAmount)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 加锁</span></span><br><span class="line">		lock.lock();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (balance &gt;= drawAmount) &#123;</span><br><span class="line">				System.out.println(Thread.currentThread().getName()+<span class="string">"取钱成功 ，吐出钞票："</span>+drawAmount);</span><br><span class="line">				Thread.sleep(<span class="number">1</span>);</span><br><span class="line">				balance-=drawAmount;</span><br><span class="line">				System.out.println(<span class="string">"余额："</span>+balance);</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  System.out.println(<span class="string">"取钱失败：余额不足"</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 修改完成，释放锁</span></span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawAmountThread</span>  <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Account  account;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span>   drawAmount;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DrawAmountThread</span><span class="params">(Account account, <span class="keyword">double</span> drawAmount)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">		<span class="keyword">this</span>.drawAmount = drawAmount;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	  account.draw(drawAmount);</span><br><span class="line">	  </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Account account=<span class="keyword">new</span> Account(<span class="string">"1234"</span>, <span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">new</span> DrawAmountThread(account, <span class="number">800</span>).start();</span><br><span class="line">		<span class="keyword">new</span> DrawAmountThread(account, <span class="number">800</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>线程通信</p>
<p>Object 类提供了  wait ,notify  ,notifyAll三个方法，这三个方法并不属于Thread ，属于Object类，但是这个三个方法必须由同步监视器对象来调用。<br>使用synchronized修饰的同步方法，因为该类的默认实例就是同步监视器，所以可以在同步方法中直接调用这三个方法</p>
<p>使用synchronized修改的同步代码块， 同步监视器是synchronized后括号里的对象，必须使用该对象调用三个方法。</p>
<p>wait()方法：  导致当前线程等待，直到其他线程调用该同步监视器的notify notifyAll()方法来唤醒该线程。调用wait方法的当前线程对释放对该同步监视器的锁定。</p>
<p>notify() 唤醒在此同步监视器上等待的单个线程，如果所有线程都在此同步监视器上等待，则会选择唤醒其中一个线程，选择是任意性的。只有当前线程放弃对该同步监视器的锁定后，（使用wait方法），才可以执行被唤醒的线程。</p>
<p>notifyAll()方法  唤醒在此同步监视器上等待的所有线程。只有当前线程放弃对该同步监视器的锁定后，才可以执行被唤醒的线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String accountNo;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> balance;</span><br><span class="line">	<span class="comment">// 标识账号是否已有存款的标志</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAccountNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountNo</span><span class="params">(String accountNo)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// public void setBalance(double balance) &#123;</span></span><br><span class="line">	<span class="comment">// this.balance = balance;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(String accountNo, <span class="keyword">double</span> balance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">		<span class="keyword">this</span>.balance = balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 取钱操作</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">double</span> drawAmount)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// flag ==false表明账号还没有人存钱进去，取钱阻塞</span></span><br><span class="line">			<span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">				<span class="comment">// object类方法</span></span><br><span class="line">				wait();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 执行取钱操作</span></span><br><span class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">"取钱："</span></span><br><span class="line">						+ drawAmount);</span><br><span class="line">				balance -= drawAmount;</span><br><span class="line">				System.out.println(<span class="string">"余额："</span> + balance);</span><br><span class="line">				<span class="comment">// 将账号标识是否已有存款设置为false</span></span><br><span class="line">				flag = <span class="keyword">false</span>;</span><br><span class="line">				<span class="comment">// 唤醒其他线程</span></span><br><span class="line">				notifyAll();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//存钱</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span>   <span class="keyword">void</span>  <span class="title">deposit</span><span class="params">(<span class="keyword">double</span>  depositAmount)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//true代表账号有人存钱，存钱阻塞</span></span><br><span class="line">			<span class="keyword">if</span>(flag)&#123;</span><br><span class="line">				wait();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//执行存钱操作</span></span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				</span><br><span class="line">				System.out.println(Thread.currentThread().getName()+<span class="string">"存款："</span>+depositAmount);</span><br><span class="line">				balance+=depositAmount;</span><br><span class="line">				System.out.println(<span class="string">"账号余额："</span>+balance);</span><br><span class="line">				<span class="comment">//修改状态，表示账号已有存款</span></span><br><span class="line">				flag=<span class="keyword">true</span>;</span><br><span class="line">				<span class="comment">//唤醒其他线程</span></span><br><span class="line">				notifyAll();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawThread</span>  <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Account  account;</span><br><span class="line">	<span class="comment">//当前取钱线程所希望取的钱数</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span>  drawAmount;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DrawThread</span><span class="params">(String name,Account account, <span class="keyword">double</span> drawAmount)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">		<span class="keyword">this</span>.drawAmount = drawAmount;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	   <span class="comment">//重复100次执行取钱操作</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			account.draw(drawAmount);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepositThread</span>  <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Account  account;</span><br><span class="line">	<span class="comment">//当前取钱线程所希望存的钱数</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span>  depositAmount;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DepositThread</span><span class="params">(String name,Account account, <span class="keyword">double</span> depositAmount)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">		<span class="keyword">this</span>.depositAmount = depositAmount;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	   <span class="comment">//重复100次执行存钱操作</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			account.deposit(depositAmount);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Account  acct=<span class="keyword">new</span>  Account(<span class="string">"1234567"</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">new</span> DrawThread(<span class="string">"取钱者"</span>, acct, <span class="number">800</span>).start();</span><br><span class="line">        <span class="keyword">new</span> DepositThread(<span class="string">"存钱者1"</span>,acct,<span class="number">800</span>).start();</span><br><span class="line">        <span class="keyword">new</span> DepositThread(<span class="string">"存钱者2"</span>,acct,<span class="number">800</span>).start();</span><br><span class="line">        <span class="keyword">new</span> DepositThread(<span class="string">"存钱者3"</span>,acct,<span class="number">800</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>使用Condition控制线程通信</p>
<p>如果程序不使用synchronizd关键字来保证同步，而是直接使用lock对象来保证同步，则系统中不存在隐式的同步监视器，也就不能使用wait ,notify  notifyAll（）方法进行线程通信了。</p>
<p>当使用Lock对象来保证同步时，java提供了一个Condition类来保持协调，使用它可以让那些已经得到Lock对象却无法继续执行的线程释放Lock对象。<br>Condition类提供了如下三个方法：</p>
<p>await()类似于同步监视器的wait方法，导致当前线程等待，直到其他线程调用该Condition的signal()方法或者signalAll来唤醒该线程。<br>signal()唤醒在此Lock对象上等待的单个线程。如果所有线程都在该lock对象上等待，则会选择唤醒其中一个线程。选择是任意性的。只有当前线程放弃对该Lock对象的锁定后（使用await）,才可以执行被唤醒的线程。<br>signalAll()唤醒在此Lock对象上等待的所有线程。并使用Condition对象来控制线程的协调运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 显示定义lock对象</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">	<span class="comment">// 获得lock对象对应的Conditon</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Condition cond = lock.newCondition();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String accountNo;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAccountNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountNo</span><span class="params">(String accountNo)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// public void setBalance(double balance) &#123;</span></span><br><span class="line">	<span class="comment">// this.balance = balance;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> balance;</span><br><span class="line">	<span class="comment">// 标识账号中是否已有存款的标识符</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(String accountNo, <span class="keyword">double</span> balance)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.accountNo = accountNo;</span><br><span class="line">		<span class="keyword">this</span>.balance = balance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">double</span> drawAmount)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 加锁</span></span><br><span class="line">		lock.lock();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// flag false 表明账号还没有人存钱进去，取钱方法阻塞</span></span><br><span class="line">			<span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">				cond.await();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 执行取钱操作</span></span><br><span class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">"取钱："</span></span><br><span class="line">						+ drawAmount);</span><br><span class="line">				balance -= drawAmount;</span><br><span class="line">				System.out.println(<span class="string">"账号余额："</span> + balance);</span><br><span class="line">				<span class="comment">// 将是否已有存款的标识设置为false</span></span><br><span class="line">				flag = <span class="keyword">false</span>;</span><br><span class="line">				cond.signalAll();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deposit</span><span class="params">(<span class="keyword">double</span> depositAmount)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		lock.lock();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//为真，存钱方法阻塞</span></span><br><span class="line">			<span class="keyword">if</span>(flag)&#123;</span><br><span class="line">				cond.await();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">			     <span class="comment">//执行存款操作</span></span><br><span class="line">				 System.out.println(Thread.currentThread().getName()+<span class="string">" 存款："</span>+depositAmount);</span><br><span class="line">				 balance+=depositAmount;</span><br><span class="line">				 System.out.println(<span class="string">"账号余额："</span>+balance);</span><br><span class="line">				 <span class="comment">//将表示账号是否已有存款的标识设置为true</span></span><br><span class="line">				 flag=<span class="keyword">true</span>;</span><br><span class="line">				 <span class="comment">//唤醒其他线程</span></span><br><span class="line">				 cond.signalAll();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//--------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepositThread</span>  <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Account  account;</span><br><span class="line">	<span class="comment">//当前取钱线程所希望存的钱数</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span>  depositAmount;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DepositThread</span><span class="params">(String name,Account account, <span class="keyword">double</span> depositAmount)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">		<span class="keyword">this</span>.depositAmount = depositAmount;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	   <span class="comment">//重复100次执行存钱操作</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			account.deposit(depositAmount);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawThread</span>  <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Account  account;</span><br><span class="line">	<span class="comment">//当前取钱线程所希望取的钱数</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span>  drawAmount;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DrawThread</span><span class="params">(String name,Account account, <span class="keyword">double</span> drawAmount)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">		<span class="keyword">this</span>.drawAmount = drawAmount;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	   <span class="comment">//重复100次执行取钱操作</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">			account.draw(drawAmount);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Account  acct=<span class="keyword">new</span>  Account(<span class="string">"1234567"</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">new</span> DrawThread(<span class="string">"取钱者"</span>, acct, <span class="number">800</span>).start();</span><br><span class="line">        <span class="keyword">new</span> DepositThread(<span class="string">"存钱者1"</span>,acct,<span class="number">800</span>).start();</span><br><span class="line">        <span class="keyword">new</span> DepositThread(<span class="string">"存钱者2"</span>,acct,<span class="number">800</span>).start();</span><br><span class="line">      <span class="comment">//  new DepositThread("存钱者3",acct,800).start();</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用阻塞队列BlockingQueue 控制线程通信</p>
<p>java5提供了一个BlockingQueue接口，它的主要作用不是作为容器，而是作为线程同步工具。当生产者试图向BlockingQueue放入元素时，队列已满，线程被阻塞；当消费者从它中取出元素时，队列已空，线程被阻塞。</p>
<p>程序的两个线程通过交替向BlockingQueue放入元素，取出元素，即可很好的控制线程的通信。<br>BlockingQueue提供如下两个支持阻塞的方法。</p>
<p>put(E e):尝试将元素E放入BlockingQueue中，如果该队列元素已满，则阻塞线程。</p>
<p>take()：尝试从BlockingQueue的头部取出元素，如果该队列的元素已空，则阻塞线程。</p>
<p>BlockingQueue继承了Queue接口，也可以使用Queue的方法，这些方法如下：</p>
<p>1在队列尾部插入元素，add(),offer(),put()当队列已满时，这三个方法会抛出异常，返回false,阻塞队列。</p>
<p>2在队列头部删除并返回删除的元素，包括，rmove(),poll(),take()队列为空时，抛出异常，返回false,阻塞队列。</p>
<p>3在队列头部取出但是不删除元素，包括element(),peek()，当队列为空时，抛出异常，返回false.</p>
<p>BlockingQueue包括5个实现类。</p>
<p>ArrayBlockingQueue  基于数组实现的BlockingQueue队列</p>
<p>LinkedBlockingQueue 基于链表实现的的BlockingQueue队列</p>
<p>PriorityBlockingQueue：它不是标准的阻塞队列，该队列调用<br>remove（），poll(),take()等方法取出元素，并不是取出队列中存在时间最长元素，而且队列中最小原色， 判断元素大小根据元素本身大小来自然排序，也可以使用Comparator定制排序</p>
<p>SynchronousQueue 同步队列，对队列的存取，操作必须交替进行</p>
<p>DelayQueue 特殊的BlockingQueue，  要求元素实现DElay接口，根据getDaly方法返回值进行排序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> BlockingQueue&lt;String&gt;  bq;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;String&gt; bq)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.bq = bq;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">		String[]  strArr=<span class="keyword">new</span> String[]&#123;</span><br><span class="line">				</span><br><span class="line">				<span class="string">"java"</span>,</span><br><span class="line">				<span class="string">"Structs"</span>,</span><br><span class="line">				<span class="string">"Spring"</span></span><br><span class="line">				</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">99999999</span>;i++)&#123;</span><br><span class="line">			</span><br><span class="line">			System.out.println(getName()+<span class="string">"生产者产生集合元素"</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">200</span>);</span><br><span class="line">				bq.put(strArr[i%<span class="number">3</span>]);</span><br><span class="line">				</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag"><span class="keyword">TODO</span></span>: handle exception</span></span><br><span class="line">			&#125;</span><br><span class="line">			System.out.println(getName()+<span class="string">"生成完成："</span>+bq);</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> BlockingQueue&lt;String&gt;  bq;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(BlockingQueue&lt;String&gt; bq)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.bq = bq;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">			System.out.println(getName()+<span class="string">"消费者准备消费集合元素"</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">200</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag"><span class="keyword">TODO</span></span>: handle exception</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				bq.take();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag"><span class="keyword">TODO</span></span> Auto-generated catch block</span></span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.println(getName()+<span class="string">"消费完成"</span>+bq);</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		   </span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingQueueTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//创建容量为1的BlockingQueue</span></span><br><span class="line">		BlockingQueue&lt;String&gt;  bq=<span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">		<span class="comment">//启动3个生产者线程</span></span><br><span class="line">		<span class="keyword">new</span> Producer(bq).start();</span><br><span class="line">		<span class="keyword">new</span> Producer(bq).start();</span><br><span class="line">		<span class="keyword">new</span> Producer(bq).start();</span><br><span class="line"><span class="comment">//启动一个消费者线程</span></span><br><span class="line">		<span class="keyword">new</span> Customer(bq).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>线程池  </p>
<p>在java5之前，开发者必须手动实现线程池；从java5之后，java内建支持线程池。java新增了一个Executors工程类来产生线程池，该工厂类包含如下几个静态工厂方法来创建线程池。</p>
<p>newFixedThread()  创建一个可重用的，具有固定线程数的线程池。</p>
<p>newSingleThreadExecutor():创建一个只有单线程的线程池，相当于newFixedThread传入参数1.</p>
<p>newScheduledThreadPool()创建具有指定线程数的线程池，它可以在指定延迟后执行线程任务。</p>
<p>newSingleThreadSchedeledExecutor():创建一个只有一个线程的线程池，它可以在指定延迟后执行线程任务。</p>
<p>ExecutorService newWorkStealingPool  :创建持有足够的线程的线程池来支持给定的并行级别，</p>
<p>ExecutorService newWorkSteadlingPool :该方法是前一个方法的简化版。</p>
<p>7个方法中，前3个放好一个ExecutorService对象，该对象代表一个线程池，它可以执行Runnalbe对象或者Callalbe对象所代表的线程；<br>中间两个方法返回一个SecheduledExecutorService 线程池，它是ExecutorService的子类</p>
<p>最后两个是java8新增的，这两个方法可以利用多cpu并行的能力。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		ExecutorService pool=Executors.newFixedThreadPool(<span class="number">6</span>);</span><br><span class="line">		Runnable target= ()-&gt;&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">				</span><br><span class="line">				System.out.println(Thread.currentThread().getName()+<span class="string">"  "</span>+i);</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		pool.submit(target);</span><br><span class="line">		pool.submit(target);</span><br><span class="line">		pool.shutdown();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>java 8增强的ForkJoinPool</p>
<p>java7提供了ForkJoinPool来支持将一个任务拆分成多个小任务并行计算，再把多个小任务的结果合并成总的计算结果。<br>ForkJoinPool 是 ExecutorService的实现类，因此是一种特殊的线程池。</p>
<p>构造器<br>ForkJoinPool(int parallelism):创建一个包含parallelism个并行线程的ForkJoinPool。<br>ForkJoinPool()以Runtime.availableProcessors()方法的返回值作为parallelism参数创建。</p>
<p>java8 进一步扩展了，增加了通用池功能。通过如下两个静态方法提供通用池功能。</p>
<p>ForkJoinPool commonPool():返回一个通用池，通用池的运行状态不受shutdown或者shutdownnow影响，当然，执行system。exit(0)来终止虚拟机，通用池及通用池中正在执行的任务都会被自动终止。</p>
<p>创建了ForkJoinPool实例后，调用ForkJoinPool 的submit  invoke方法来执行指定任务了。其中，ForkJoinTask代表一个可以并行，合并的任务。ForkJoinTask是一个抽象类，它还有两个抽象类：<br>RecursiveAction  有返回值的任务<br>RecursiveTask    没有返回值的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintTask</span> <span class="keyword">extends</span> <span class="title">RecursiveAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THRESHOLD = <span class="number">50</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> start;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PrintTask</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.start = start;</span><br><span class="line">		<span class="keyword">this</span>.end = end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (end - start &lt; THRESHOLD) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; end; i++) &#123;</span><br><span class="line">				System.out.println(Thread.currentThread().getName()+<span class="string">" "</span>+i);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="comment">//将大任务分解成两个小任务</span></span><br><span class="line">			          <span class="keyword">int</span> middle=(start+end)/<span class="number">2</span>;</span><br><span class="line">			          PrintTask  left=<span class="keyword">new</span> PrintTask(start, middle);</span><br><span class="line">			          PrintTask  right=<span class="keyword">new</span> PrintTask(middle, end);</span><br><span class="line">			          left.fork();</span><br><span class="line">			          right.fork();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinPoolTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		ForkJoinPool pool=<span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">		<span class="comment">//提交可分解任务</span></span><br><span class="line">		pool.submit(<span class="keyword">new</span> PrintTask(<span class="number">0</span>, <span class="number">300</span>));</span><br><span class="line">        pool.awaitTermination(<span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">        pool.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//带返回值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THRESHOLD = <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> arr[];</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> start;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CallTask</span><span class="params">(<span class="keyword">int</span>[] arr, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.arr = arr;</span><br><span class="line">		<span class="keyword">this</span>.start = start;</span><br><span class="line">		<span class="keyword">this</span>.end = end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Integer <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (end - start &lt; THRESHOLD) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; end; i++) &#123;</span><br><span class="line">				sum += arr[i];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> sum;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 累加超过20个，分解任务</span></span><br><span class="line">			<span class="keyword">int</span> middle = (start + end) / <span class="number">2</span>;</span><br><span class="line">			CallTask left = <span class="keyword">new</span> CallTask(arr, start, middle);</span><br><span class="line">			CallTask right = <span class="keyword">new</span> CallTask(arr, middle, end);</span><br><span class="line">			<span class="comment">// 并行执行任务</span></span><br><span class="line">			left.fork();</span><br><span class="line">			right.fork();</span><br><span class="line">			<span class="keyword">return</span> left.join() + right.join();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SumTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> []arr=<span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">100</span>];</span><br><span class="line">		Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">int</span> total=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>,len=arr.length;i&lt;len;i++)&#123;</span><br><span class="line">			<span class="keyword">int</span> tmp=rand.nextInt(<span class="number">20</span>);</span><br><span class="line">			total+=(arr[i]=tmp);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(total);</span><br><span class="line">        <span class="comment">//创建一个通用池</span></span><br><span class="line">		ForkJoinPool  pool=ForkJoinPool.commonPool();</span><br><span class="line">		Future&lt;Integer&gt; future=pool.submit(<span class="keyword">new</span> CallTask(arr, <span class="number">0</span>, arr.length));</span><br><span class="line">		System.out.println(future.get());</span><br><span class="line">		<span class="comment">//关闭线程池</span></span><br><span class="line">		pool.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ThreadLocal类</p>
<p>是线程局部变量的意思，功能很简单，就是为每个使用该变量的线程都提供一个变量值的副本，使每个线程都可以独立的改变自己的副本。<br>ThreadLocal类的用法非常简单，它只提供了如下三个public 方法。</p>
<p>T get()  :返回此线程局部变量中的当前线程副本中的值<br>void remove()删除此线程局部变量中当前线程的值<br>void set(T value):设置此线程局部变量中当前线程副本中的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> ThreadLocal&lt;String&gt; name=<span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name.set(str);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String  <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name.get();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span>  <span class="keyword">void</span>   <span class="title">setName</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name.set(str);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span>  Account account;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyTest</span><span class="params">(Account  account,String name)</span></span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name);</span><br><span class="line">		<span class="keyword">this</span>.account=account;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">			<span class="comment">//i==6时输出将账号名替换当前线程名</span></span><br><span class="line">			<span class="keyword">if</span>(i==<span class="number">6</span>)&#123;</span><br><span class="line">				account.setName(getName());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//输出同一个账户的账户名和循环变量</span></span><br><span class="line">			System.out.println(account.getName()+<span class="string">" account i value"</span>+i);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		Account  at=<span class="keyword">new</span> Account(<span class="string">"init name"</span>);</span><br><span class="line">		<span class="comment">/**</span><br><span class="line">		 * 虽然两个线程共享一个账号，即只有一个账号名</span><br><span class="line">		 * 但是由于账号名是ThreadLocal类型，所以每个线程</span><br><span class="line">		 * 都完全拥有各自的账号名副本，因此在i==6之后，看到两个线程访问同一账号出现不同的账号名</span><br><span class="line">		 */</span></span><br><span class="line">		<span class="keyword">new</span> MyTest(at, <span class="string">"one"</span>).start();</span><br><span class="line">		<span class="keyword">new</span> MyTest(at,<span class="string">"two"</span>).start();</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ThreadLocal和其他所有同步机制一样，都是为了解决多线程中对同一变量的访问冲突，在普通的同步机制中，是通过对象加锁来实现多个线程对同一变量的安全访问的，该变量是多个线程共享的，所以要使用这种同步机制，需要很细致的分析什么时候对变量进行读写，什么时候需要锁定某 个对象，什么时候释放该对象的锁等。在这种情况下，系统并没有将这份资源复制多份，只是采用了安全机制来控制对这份资源的访问而已。</p>
<p>ThreadLocal从另一个角度来解决多线程的并发访问。ThreadLocal将需要并发访问的资源复制多份，每个线程拥有一份资源，每个线程都拥有自己的资源副本，从而也就没有必要对该变量进行同步了。ThreadLocal 提供了线程安全的共享对象，在编写多线程代码时，可以把不安全的整个变量封装进ThreadLocal,或者把该对象与线程相关的状态使用ThreadLocal保持。</p>
<p>ThreadLocal 并不能代替同步机制，两者面向的问题领域不同。同步机制是为了同步多个线程对相同资源的并发访问，是多个线程之间进行通信的有效方式；而ThreadLocal是为了隔离多个线程的数据共享，从根本上避免多个线程之间对共享资源（变量）的竞争，也就不需要对多个线程进行同步了。</p>
<p>通常建议，如果多个线程之间需要共享资源，以达到线程之间的通信功能，使用同步机制；如果仅仅需要隔离多个线程之间的共享冲突，则可以使用ThreadLocal。</p>
<p>包装线程不安全的集合</p>
<p>java集合里，中ArrayList,LinkedList ,HashSet,TreeSet, HashMap,TreeMap等都是线程不安全的，也就是说，当多个并发线程向这些集合中存，取元素时，就可能破坏这些集合的数据完整性。<br>如果程序中有多个线程可能访问以上集合，就可以使用Collections提供的类方法把这些集合包装成线程安全的类的集合，Collections提供了方法。<br>Collections.synchronizedCollection();<br>Collections.synchronizedList();<br>。。。。。等方法</p>
<p>线程安全的集合类</p>
<p>以Concurrent开头的集合类 ConcurrentHashMap,ConcurrentSkipListMap.ConcurrentSkipListSet<br>ConcurrentLinkedQueue 。。。<br>CopyOnWrite开头的集合类<br>CopyOnWriteArrayList  CopyOnWriteArraySet ..</p>
<p>其中以Concurrent开头的集合类代表了支持并发访问的集合，它们支持多个线程并发写入访问，这些写入线程操作都是线程安全的，单读取操作不必锁定。以Concurrent开头的集合类采用了更复杂的算法来保证永远不会锁住整个集合，因此在并发写入时有较好的性能。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/11/java-multi-thread/" data-id="ciguwqj6w000xswfhu2di0xmk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2015/11/02/java-basic-data-type/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">java_basic_data_type</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源项目/">开源项目</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码分析/">源码分析</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/java/" style="font-size: 18px;">java</a> <a href="/tags/开源项目/" style="font-size: 10px;">开源项目</a> <a href="/tags/源码分析/" style="font-size: 12px;">源码分析</a> <a href="/tags/算法/" style="font-size: 16px;">算法</a> <a href="/tags/设计模式/" style="font-size: 14px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/11/11/java-multi-thread/">java_multi_thread</a>
          </li>
        
          <li>
            <a href="/2015/11/02/java-basic-data-type/">java_basic_data_type</a>
          </li>
        
          <li>
            <a href="/2015/10/26/insert-insert-sort/">insert_insert_sort</a>
          </li>
        
          <li>
            <a href="/2015/10/26/android-start-mode/">android_start_mode</a>
          </li>
        
          <li>
            <a href="/2015/10/23/android-event/">android_event</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>